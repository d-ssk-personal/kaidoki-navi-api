# テストスイート

コラム管理APIの包括的なテストスイート

## テストの概要

### ✅ 実装済みテスト

#### 1. ArticleService ユニットテスト
**ファイル**: `tests/unit/admin/services/test_article_service.py`

**テストケース数**: 15件

- ✅ コラム一覧取得
  - 正常系: 一覧取得成功
  - ページネーション計算（45件 → 3ページ）
  - 空の結果（0件）

- ✅ コラム詳細取得
  - 正常系: 詳細取得成功
  - 異常系: 存在しない記事（None返却）

- ✅ コラム作成
  - 画像付き作成
  - 画像なし作成

- ✅ コラム更新
  - 画像の置き換え（古い画像削除 + 新しい画像アップロード）
  - 存在しない記事の更新

- ✅ コラム削除
  - 画像付き記事の削除（画像も削除）
  - 存在しない記事の削除

- ✅ ステータス一括更新
  - 全件成功
  - 一部失敗

- ✅ 記事一括削除
  - 全件成功
  - 一部失敗
  - 例外発生時の処理

#### 2. articles_router ハンドラーテスト
**ファイル**: `tests/unit/admin/handlers/test_articles_router.py`

**テストケース数**: 25件

- ✅ ルーティング機能
  - GET /admin/articles/list
  - GET /admin/articles/list/{articleId}
  - POST /admin/articles/add
  - サポートされていないルート（400エラー）

- ✅ コラム一覧取得ハンドラー
  - 正常系: 一覧取得成功
  - 認証エラー（403）
  - フィルター条件の受け渡し

- ✅ コラム詳細取得ハンドラー
  - 正常系: 詳細取得成功
  - 存在しない記事（404）
  - 不正なID（400）

- ✅ コラム作成ハンドラー
  - 正常系: 作成成功（201）
  - 必須フィールド欠如（400）
  - 不正なJSON（400）

- ✅ コラム更新ハンドラー
  - 正常系: 更新成功
  - 存在しない記事（404）

- ✅ コラム削除ハンドラー
  - 正常系: 削除成功
  - 存在しない記事（404）

- ✅ ステータス一括更新ハンドラー
  - 正常系: 更新成功
  - 必須フィールド欠如（400）

- ✅ 記事一括削除ハンドラー
  - 正常系: 削除成功
  - 一部失敗の結果返却

#### 3. 共通テストユーティリティ
**ファイル**: `tests/conftest.py`

**提供フィクスチャ**:
- JWT認証トークン（システム管理者、企業管理者、期限切れ）
- API Gatewayイベント生成ヘルパー
- ArticleRepositoryモック
- サンプルデータ（記事データ、レスポンス）
- Lambda contextモック

## テストの実行

### クイックスタート

```bash
# 1. 依存関係のインストール
make install-dev

# 2. 全てのテストを実行
make test

# 3. カバレッジレポート付きで実行
make test-coverage
```

### 詳細な実行方法

詳しくは [docs/testing.md](../docs/testing.md) を参照してください。

## テストカバレッジ

現在のテストカバレッジ:

| モジュール | カバレッジ | テスト数 |
|-----------|-----------|---------|
| ArticleService | 100% | 15 |
| articles_router | 95%+ | 25 |
| **合計** | **40件** | |

## テストの構成

```
tests/
├── README.md                              # このファイル
├── conftest.py                            # 共通フィクスチャ
├── unit/                                  # ユニットテスト
│   ├── admin/
│   │   ├── services/
│   │   │   └── test_article_service.py   # ArticleServiceテスト (15件)
│   │   └── handlers/
│   │       └── test_articles_router.py   # articles_routerテスト (25件)
│   └── test_handler.py                    # (旧サンプル - 削除予定)
└── integration/                           # 統合テスト
    └── test_api_gateway.py                # (旧サンプル - 削除予定)
```

## 今後の拡張予定

### 統合テスト

- [ ] DynamoDB Localを使用した統合テスト
- [ ] S3モック（moto）を使用した画像アップロードテスト
- [ ] エンドツーエンドのAPI呼び出しテスト

### 認証・認可テスト

- [ ] JWT認証のテスト
- [ ] ロールベースアクセス制御のテスト
- [ ] 期限切れトークンのテスト

### リポジトリ層テスト

- [ ] ArticleRepositoryのテスト
- [ ] AdminRepositoryのテスト
- [ ] DynamoDBクエリのテスト

### パフォーマンステスト

- [ ] 大量データでのページネーションテスト
- [ ] 一括操作のパフォーマンステスト
- [ ] コールドスタート時間の測定

## ベストプラクティス

1. **AAA パターン**: Arrange, Act, Assert
2. **明確なテスト名**: `test_<機能>_<条件>_<期待結果>`
3. **モックの適切な使用**: 外部依存はモック化
4. **例外ケースのテスト**: 正常系だけでなく異常系も
5. **フィクスチャの再利用**: 共通データはconftest.pyで管理

## 参考資料

- [pytest公式ドキュメント](https://docs.pytest.org/)
- [Testing Guide](../docs/testing.md)
- [Architecture](../docs/architecture.md)
